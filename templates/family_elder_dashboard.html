{% extends 'base.html' %}
{% load static %}

{% block title %}智慧养老平台 - {% if elder %}{{ elder.name }}的详细信息{% else %}家属监护中心{% endif %}{% endblock %}

{% block extra_css %}
<!-- 用户信息元数据 -->
<meta name="user-id" content="{{ request.user.id }}">
<meta name="user-name" content="{{ request.user.username }}">
<meta name="elder-id" content="{{ elder.id|default:'' }}">
<meta name="family-id" content="{{ family_member.id|default:'' }}">

<!-- ApexCharts图表库 -->
<link href="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/apexcharts@3.26.0/dist/apexcharts.css" rel="stylesheet">
<style>
    /* 修改页面主体布局 */
    .container-fluid {
        padding: 1rem;
    }
    
    /* 卡片样式 */
    .dashboard-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1rem;
        overflow: hidden;
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        opacity: 1;
        position: relative;
        z-index: 10;
    }
    
    .card-header-custom {
        background: linear-gradient(135deg, #f5f7fa 0%, #e5e9f2 100%);
        padding: 12px 16px;
        font-weight: 600;
        color: #495057;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
    }
    
    .card-header-custom i {
        margin-right: 8px;
    }
    
    /* 健康图表 */
    .health-chart {
        height: 250px;
        width: 100%;
    }
    
    /* 健康数据卡片 */
    .health-stats-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 10px;
    }
    
    .health-stat-card {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        height: 80px;
        opacity: 1;
    }
    
    .health-icon {
        width: 40px;
        height: 40px;
        min-width: 40px;
        border-radius: 50%;
        background-color: #f8f9fa;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 18px;
    }
    
    .health-icon.status-normal {
        background-color: #e8f5e9;
        color: #28a745;
    }
    
    .health-icon.status-warning {
        background-color: #fff3e0;
        color: #fd7e14;
    }
    
    .health-icon.status-danger {
        background-color: #ffebee;
        color: #dc3545;
    }
    
    .health-stat-info {
        flex-grow: 1;
    }
    
    .health-stat-info h4 {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0 0 5px 0;
    }
    
    .health-stat-info h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 3px 0;
    }
    
    .health-stat-info p {
        font-size: 0.8rem;
        color: #6c757d;
        margin: 0;
    }
    
    /* 设备控制 */
    .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
        grid-gap: 20px;
        padding: 15px;
    }
    
    .device-card {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 10;
        transition: all 0.3s ease;
        cursor: pointer;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        text-align: center;
    }
    
    .device-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        background-color: rgba(255, 255, 255, 0.9);
    }
    
    .device-card.active {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-color: #2196F3;
    }
    
    /* 美化设备图标 */
    .device-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 24px;
        background: linear-gradient(135deg, rgba(255,255,255,0.5), rgba(255,255,255,0.8));
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        border: 2px solid rgba(255,255,255,0.8);
        transition: all 0.3s ease;
    }
    
    .device-card:hover .device-icon {
        transform: scale(1.1);
    }
    
    /* 设备名称 */
    .device-card h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #444;
    }
    
    /* 设备开关 */
    .device-toggle {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
        margin-bottom: 0;
    }
    
    .device-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .device-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #e9ecef;
        transition: .4s;
        border-radius: 34px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .device-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    input:checked + .device-slider {
        background-color: #2196F3;
    }
    
    input:checked + .device-slider:before {
        transform: translateX(30px);
    }
    
    /* 监控视频 */
    .monitoring-grid {
        display: grid;
        grid-template-columns: 1fr;
        grid-gap: 10px;
    }
    
    .monitoring-card {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        height: 180px;
    }
    
    .monitoring-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0,0,0,0.7));
        padding: 10px;
        color: white;
        display: flex;
        justify-content: space-between;
    }
    
    .monitoring-controls button {
        background: none;
        border: none;
        color: white;
        font-size: 1rem;
        margin-left: 8px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    .monitoring-controls button:hover {
        opacity: 1;
    }
    
    /* 全屏监控 */
    .expanded-monitoring {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.9);
        z-index: 1060;
        display: none;
    }
    
    .close-expanded {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 24px;
        cursor: pointer;
        z-index: 1061;
    }
    
    .expanded-video {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 80%;
    }
    
    .expanded-video img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    /* 抽屉菜单 */
    .drawer {
        position: fixed;
        bottom: -100%;  /* 从底部弹出 */
        left: 0;
        right: 0;
        background-color: #f8f9fa;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-shadow: 0 -10px 25px rgba(0,0,0,0.15);
        height: auto;
        max-height: 85vh;
        transition: bottom 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        z-index: 2500;
        overflow-y: auto;
        border: none;
    }
    
    .drawer.open {
        bottom: 0;
    }
    
    .drawer-header {
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .drawer-title {
        font-weight: 600;
        font-size: 1.2rem;
        color: #343a40;
    }
    
    .drawer-close {
        background: #e9ecef;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: #495057;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .drawer-close:hover {
        background: #dee2e6;
        color: #212529;
    }
    
    .drawer-body {
        padding: 25px;
        background-color: white;
    }
    
    /* 空调按钮样式 */
    .temperature-control {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 30px 0;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 15px;
    }
    
    .temp-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background-color: white;
        color: #495057;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.2s;
    }
    
    .temp-btn:hover {
        background-color: #007bff;
        color: white;
        transform: scale(1.05);
    }
    
    /* 空调控制按钮 */
    .ac-controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 15px;
        margin-top: 20px;
    }
    
    .ac-control-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border: none;
        border-radius: 15px;
        padding: 15px 10px;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .ac-control-btn:hover {
        background-color: #e9ecef;
        transform: translateY(-3px);
    }
    
    .ac-control-btn i {
        font-size: 24px;
        margin-bottom: 8px;
        color: #6c757d;
    }
    
    /* 子抽屉样式 */
    .sub-drawer {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        background-color: white;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-shadow: 0 -10px 25px rgba(0,0,0,0.15);
        max-height: 85vh;
        overflow-y: auto;
        z-index: 2501; /* 比主抽屉高一级 */
        transition: bottom 0.3s cubic-bezier(0.19, 1, 0.22, 1);
    }
    
    /* 选项图标样式 */
    .option-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #6c757d;
    }
    
    .cool-icon {
        background-color: #e3f2fd;
        color: #0d6efd;
    }
    
    .heat-icon {
        background-color: #ffebee;
        color: #dc3545;
    }
    
    .fan-icon {
        background-color: #e8f5e9;
        color: #198754;
    }
    
    /* 选择检查图标 */
    .mode-check, .speed-check, .direction-check {
        visibility: hidden;
        color: #198754;
    }
    
    /* 旋转动画 */
    .fa-spin-fast {
        animation: fa-spin 1s infinite linear;
    }
    
    /* 范围滑块样式增强 */
    .range-container {
        padding: 10px 0;
    }
    
    /* 修复滑块控件样式 */
    .slider-container {
        display: flex;
        flex-direction: column;
        margin-bottom: 25px;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 15px;
    }
    
    .slider-label {
        margin-bottom: 15px;
        color: #495057;
        font-weight: 500;
        font-size: 1rem;
    }
    
    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 10px;
        border-radius: 5px;
        background: #dee2e6;
        outline: none;
        margin-top: 5px;
        margin-bottom: 15px;
    }
    
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* 房间控制样式 */
    .room-control {
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        padding: 15px;
        background-color: white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .room-title {
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        color: #343a40;
        font-size: 1.1rem;
    }
    
    .room-icon {
        margin-right: 10px;
        color: #6c757d;
        font-size: 18px;
        width: 32px;
        height: 32px;
        background-color: #e9ecef;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* 修复遮罩层样式 */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(3px);
        z-index: 2400;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }
    
    .overlay.open {
        opacity: 1;
        pointer-events: auto;
    }
    
    /* 灯光控制 */
    .light-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 15px;
    }
    
    .light-item {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    
    .light-icon {
        font-size: 24px;
        margin-bottom: 10px;
        color: #ffc107;
    }
    
    /* 美化空调温度按钮 */
    .btn-temperature-control {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        background-color: #e9ecef;
        color: #495057;
        transition: all 0.2s;
    }
    
    .btn-temperature-control:hover {
        background-color: #007bff;
        color: white;
    }

    /* 空调当前温度显示 */
    .current-temp {
        font-size: 2rem;
        font-weight: 500;
        color: #495057;
    }
    
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: white;
        border-left: 4px solid #4caf50;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        z-index: 9999;
        max-width: 300px;
        animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
        animation-fill-mode: forwards;
    }
    
    .toast-info {
        border-left-color: #2196F3;
    }
    
    .toast-warning {
        border-left-color: #FF9800;
    }
    
    .toast-error {
        border-left-color: #F44336;
    }
    
    .toast-success {
        border-left-color: #4CAF50;
    }
    
    .toast-icon {
        margin-right: 12px;
        font-size: 18px;
    }
    
    .toast-info .toast-icon {
        color: #2196F3;
    }
    
    .toast-warning .toast-icon {
        color: #FF9800;
    }
    
    .toast-error .toast-icon {
        color: #F44336;
    }
    
    .toast-success .toast-icon {
        color: #4CAF50;
    }
    
    .toast-content {
        flex-grow: 1;
        font-size: 14px;
    }
    
    .toast-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #999;
        margin-left: 10px;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    /* 适配手机屏幕 */
    @media (max-width: 768px) {
        .health-stats-container {
            grid-template-columns: 1fr;
        }
        
        .drawer {
            width: 300px;
        }
    }
    
    /* 视频通话界面样式 */
    .video-call-container {
        display: flex;
        flex-direction: column;
        height: 400px;
    }
    
    .video-streams {
        display: flex;
        flex-direction: column;
        position: relative;
        flex-grow: 1;
        background-color: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .remote-stream {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background-color: #333;
    }
    
    .local-stream {
        position: absolute;
        right: 10px;
        bottom: 10px;
        width: 120px;
        height: 90px;
        border-radius: 4px;
        border: 2px solid white;
        object-fit: cover;
        background-color: #333;
    }
    
    .call-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
    }
    
    .call-control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .incoming-call-container {
        text-align: center;
        padding: 20px;
    }
    
    .caller-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e9ecef;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: #6c757d;
    }
    
    .call-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }
    
    .accept-btn {
        background-color: #28a745;
        color: white;
    }
    
    .reject-btn {
        background-color: #dc3545;
        color: white;
    }
    
    /* 奇思闪光效果 */
    @keyframes rotating {
        0% { transform: rotate(0); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
        100% { transform: rotate(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4 family-dashboard">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'family_dashboard' %}">首页</a></li>
                    {% if elder %}
                    <li class="breadcrumb-item active" aria-current="page">{{ elder.name }} 综合监护</li>
                    {% else %}
                    <li class="breadcrumb-item active" aria-current="page">家属监护中心</li>
                    {% endif %}
                </ol>
            </nav>
        </div>
    </div>
    
    {% if no_elder_data %}
    <!-- 未关联老人的提示界面 -->
    <div class="card shadow-sm mb-4">
        <div class="card-body text-center py-5">
            <i class="fas fa-user-plus fa-4x text-muted mb-4"></i>
            <h3>您尚未关联任何老人</h3>
            <p class="text-muted mb-4">请联系管理员或申请关联老人信息，以便查看完整的监护功能</p>
            
            {% if elder_requests %}
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> 您有进行中的关联申请</h5>
                <ul class="list-unstyled">
                    {% for req in elder_requests %}
                    <li class="mb-2">
                        <strong>申请老人:</strong> {{ req.elder_name }} 
                        <span class="badge bg-{% if req.status == 'pending' %}warning{% elif req.status == 'approved' %}success{% else %}danger{% endif %}">
                            {{ req.get_status_display }}
                        </span>
                        <br>
                        <small class="text-muted">申请时间: {{ req.created_at|date:"Y-m-d H:i" }}</small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#elderAssociationModal">
                <i class="fas fa-plus-circle"></i> 申请关联老人
            </button>
        </div>
    </div>
    
    <!-- 申请关联老人的模态框 -->
    <div class="modal fade" id="elderAssociationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">申请关联老人</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'submit_elder_association_request' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="elderName" class="form-label">老人姓名</label>
                            <input type="text" class="form-control" id="elderName" name="elderName" required>
                        </div>
                        <div class="mb-3">
                            <label for="elderPhone" class="form-label">联系电话</label>
                            <input type="tel" class="form-control" id="elderPhone" name="elderPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="elderAddress" class="form-label">居住地址</label>
                            <input type="text" class="form-control" id="elderAddress" name="elderAddress" required>
                        </div>
                        <div class="mb-3">
                            <label for="relationship" class="form-label">与老人关系</label>
                            <select class="form-select" id="relationship" name="relationship" required>
                                <option value="">请选择</option>
                                <option value="son">儿子</option>
                                <option value="daughter">女儿</option>
                                <option value="grandson">孙子</option>
                                <option value="granddaughter">孙女</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="requestReason" class="form-label">申请原因</label>
                            <textarea class="form-control" id="requestReason" name="requestReason" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">提交申请</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <!-- 页面主体内容 -->
    <div class="row">
        <!-- 左侧列 - 健康数据与设备控制 -->
        <div class="col-lg-8">
            <!-- 两列布局的健康数据概览 -->
            <div class="row mb-4">
                <!-- 健康状态区域 -->
                <div class="col-lg-8">
                    <!-- 健康状态卡片 -->
                    <div class="card dashboard-card">
                        <div class="card-header-custom d-flex justify-content-between">
                            <div>
                                <i class="fas fa-heartbeat text-danger"></i>
                                <span>健康状态</span>
                            </div>
                            <div>
                                <select class="form-select form-select-sm d-inline-block me-2" id="chartType" style="width: auto;">
                                    <option value="line">折线图</option>
                                    <option value="area">面积图</option>
                                    <option value="bar">柱状图</option>
                                </select>
                                <select class="form-select form-select-sm d-inline-block me-2" id="chartPeriod" style="width: auto;">
                                    <option value="week">一周</option>
                                    <option value="month">一月</option>
                                </select>
                                <button id="refreshHealthData" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <!-- 健康数据图表 -->
                            <div id="healthChart" class="health-chart"></div>
                        </div>
                    </div>
                </div>

                <!-- 健康数据卡片 -->
                <div class="col-lg-4">
                    <div class="health-stats-container">
                        <div class="health-stat-card">
                            <div class="health-icon status-normal">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="health-stat-info">
                                <h4>心率</h4>
                                <h3 id="heartRate">75</h3>
                                <p>次/分</p>
                            </div>
                        </div>
                        <div class="health-stat-card">
                            <div class="health-icon status-normal">
                                <i class="fas fa-lungs"></i>
                            </div>
                            <div class="health-stat-info">
                                <h4>血氧</h4>
                                <h3 id="bloodOxygen">98%</h3>
                                <p>SpO₂</p>
                            </div>
                        </div>
                        <div class="health-stat-card">
                            <div class="health-icon status-normal">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="health-stat-info">
                                <h4>体温</h4>
                                <h3 id="temperature">36.5°C</h3>
                                <p>摄氏度</p>
                            </div>
                        </div>
                        <div class="health-stat-card">
                            <div class="health-icon status-normal">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="health-stat-info">
                                <h4>血压</h4>
                                <h3 id="bloodPressure">120/80</h3>
                                <p>mmHg</p>
                            </div>
                        </div>
                        <div class="health-stat-card">
                            <div class="health-icon status-normal">
                                <i class="fas fa-walking"></i>
                            </div>
                            <div class="health-stat-info">
                                <h4>步数</h4>
                                <h3 id="steps">5632</h3>
                                <p>今日步数</p>
                            </div>
                        </div>
                        <div class="health-stat-card">
                            <div class="health-icon status-normal">
                                <i class="fas fa-bed"></i>
                            </div>
                            <div class="health-stat-info">
                                <h4>睡眠</h4>
                                <h3 id="sleepQuality">7.2小时</h3>
                                <p>昨晚睡眠</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 智能家居控制部分 -->
            <div class="card dashboard-card device-control-section mb-4">
                <div class="card-header-custom">
                    <i class="fas fa-home text-primary"></i>
                    <span>智能家居控制</span>
                </div>
                <div class="card-body p-3 device-grid-container">
                    <div class="device-grid">
                        <div class="device-card" id="lightCard" data-device="light" data-location="living_room">
                            <div class="device-icon" style="color: #f8d62b;">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h5>客厅灯光</h5>
                            <label class="device-toggle">
                                <input type="checkbox" class="device-control" data-type="light" data-location="living_room" checked>
                                <span class="device-slider"></span>
                            </label>
                        </div>
                        <div class="device-card" id="ventilationCard" data-device="ventilation" data-location="kitchen">
                            <div class="device-icon" style="color: #4299e1;">
                                <i class="fas fa-wind"></i>
                            </div>
                            <h5>吸油烟机</h5>
                            <label class="device-toggle">
                                <input type="checkbox" class="device-control" data-type="ventilation" data-location="kitchen">
                                <span class="device-slider"></span>
                            </label>
                        </div>
                        <div class="device-card" id="acCard" data-device="ac" data-location="living_room">
                            <div class="device-icon" style="color: #48bb78;">
                                <i class="fas fa-snowflake"></i>
                            </div>
                            <h5>空调</h5>
                            <label class="device-toggle">
                                <input type="checkbox" class="device-control" data-type="ac" data-location="living_room">
                                <span class="device-slider"></span>
                            </label>
                            <div class="mt-2 d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-secondary py-0 px-2 btn-temperature-control" id="tempDown">-</button>
                                <span class="current-temp">26°C</span>
                                <button class="btn btn-sm btn-outline-secondary py-0 px-2 btn-temperature-control" id="tempUp">+</button>
                            </div>
                        </div>
                        <div class="device-card" id="doorLockCard" data-device="lock" data-location="front_door">
                            <div class="device-icon" style="color: #ecc94b;">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h5>门锁</h5>
                            <button class="btn btn-sm btn-outline-primary mt-2" id="temporaryUnlock">临时解锁</button>
                        </div>
                        <div class="device-card" id="waterHeaterCard" data-device="water_heater" data-location="bathroom">
                            <div class="device-icon" style="color: #ed8936;">
                                <i class="fas fa-hot-tub"></i>
                            </div>
                            <h5>热水器</h5>
                            <label class="device-toggle">
                                <input type="checkbox" class="device-control" data-type="water_heater" data-location="bathroom">
                                <span class="device-slider"></span>
                            </label>
                            <div class="mt-2">
                                <select class="form-select form-select-sm">
                                    <option>50°C</option>
                                    <option>55°C</option>
                                    <option>60°C</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
        
        <!-- 右侧列 - 监控视频和通讯 -->
        <div class="col-lg-4">
            <!-- 视频监控 -->
            <div class="card dashboard-card mb-3">
                <div class="card-header-custom d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-video text-danger"></i>
                        <span>视频监控</span>
                        <span class="badge bg-success ms-2">在线</span>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" id="fullscreenBtn">
                        <i class="fas fa-external-link-alt"></i> 全屏查看
                    </button>
                </div>
                <div class="card-body p-2">
                    <div class="monitoring-grid">
                        <div class="monitoring-card">
                            <img id="monitoringImage" src="{% static 'img/demo/living_room.jpg' %}" alt="客厅" style="width:100%; height:100%; object-fit:cover;">
                            <div class="monitoring-overlay">
                                <span id="monitoringLocation">客厅</span>
                                <div class="monitoring-controls">
                                    <button id="expandBtn" title="放大"><i class="fas fa-expand-alt"></i></button>
                                    <button id="screenshotBtn" title="截屏"><i class="fas fa-camera"></i></button>
                                    <button id="intercomBtn" title="对讲"><i class="fas fa-microphone"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center mt-1">
                        <button class="btn btn-sm btn-outline-primary me-2" id="prevCamera"><i class="fas fa-chevron-left"></i></button>
                        <span class="align-self-center" style="min-width: 40px; text-align: center;" id="cameraCounter">1 / 3</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" id="nextCamera"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- 告警通知 -->
            <div class="card dashboard-card mb-3">
                <div class="card-header-custom">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <span>告警通知</span>
                    {% if recent_alerts %}
                    <span class="badge bg-danger ms-2">{{ recent_alerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                    {% if recent_alerts %}
                        {% for alert in recent_alerts %}
                        <div class="alert-item">
                            <div class="d-flex justify-content-between">
                                <strong>{{ alert.alert_type }}</strong>
                                <span class="alert-time">{{ alert.timestamp|date:"m-d H:i" }}</span>
                            </div>
                            <p>{{ alert.description }}</p>
                            <div class="text-end">
                                <button class="btn btn-sm btn-outline-primary">查看详情</button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                            <p>目前暂无告警信息</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 健康信息摘要 -->
            <div class="card dashboard-card mb-3">
                <div class="card-header-custom">
                    <i class="fas fa-notes-medical text-primary"></i>
                    <span>健康摘要</span>
                </div>
                <div class="card-body p-3">
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">近期指标分析</h6>
                        <p>血压稳定正常，血糖指标略有波动但在正常范围内。睡眠质量良好，建议继续保持规律作息。</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">医生建议</h6>
                        <p>适当增加户外活动，每天步行30分钟。饮食上建议减少盐分摄入，增加新鲜蔬果。</p>
                    </div>
                    <div class="mb-2">
                        <h6 class="text-muted mb-2">用药提醒</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-pills text-info me-2"></i> 降压药：每日早晚各一次</li>
                            <li><i class="fas fa-pills text-warning me-2"></i> 钙片：每日一次随餐</li>
                        </ul>
                    </div>
                    <div class="text-end mt-3">
                        <button class="btn btn-sm btn-outline-primary">查看完整健康档案</button>
                    </div>
                </div>
            </div>

            <!-- 快捷控制按钮 -->
            <div class="card dashboard-card">
                <div class="card-header-custom">
                    <i class="fas fa-bolt text-warning"></i>
                    <span>快捷功能</span>
                </div>
                <div class="card-body p-3">
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" id="videoCallBtn">
                                <i class="fas fa-video"></i><br>视频通话
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-success w-100" id="healthReportBtn">
                                <i class="fas fa-file-medical"></i><br>健康报告
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-info w-100" id="medicineReminderBtn">
                                <i class="fas fa-pills"></i><br>用药提醒
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-warning w-100" id="emergencyContactBtn">
                                <i class="fas fa-ambulance"></i><br>紧急联系
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if not no_elder_data %}
<!-- 扩展的监控视频 -->
<div class="expanded-monitoring" id="expandedMonitoring">
    <i class="fas fa-times close-expanded" id="closeExpandedBtn"></i>
    <div class="expanded-video">
        <img id="expandedVideo" src="" alt="">
    </div>
</div>

<!-- 添加遮罩层 -->
<div class="overlay" id="overlay"></div>

<!-- 灯光控制抽屉 -->
<div class="drawer" id="lightDrawer">
    <div class="drawer-header">
        <div class="drawer-title">灯光控制</div>
        <button class="drawer-close" id="lightDrawerClose">×</button>
    </div>
    <div class="drawer-body">
        <div class="room-control">
            <div class="room-title"><i class="fas fa-couch room-icon"></i> 客厅灯光</div>
            <div class="slider-container">
                <span class="slider-label">亮度</span>
                <input type="range" min="0" max="100" value="70" class="slider" id="livingRoomBrightness">
            </div>
        </div>
        <div class="room-control">
            <div class="room-title"><i class="fas fa-bed room-icon"></i> 卧室灯光</div>
            <div class="slider-container">
                <span class="slider-label">亮度</span>
                <input type="range" min="0" max="100" value="50" class="slider" id="bedroomBrightness">
            </div>
        </div>
        <div class="room-control">
            <div class="room-title"><i class="fas fa-utensils room-icon"></i> 厨房灯光</div>
            <div class="slider-container">
                <span class="slider-label">亮度</span>
                <input type="range" min="0" max="100" value="90" class="slider" id="kitchenBrightness">
            </div>
        </div>
        <div class="room-control">
            <div class="room-title"><i class="fas fa-toilet room-icon"></i> 卫生间灯光</div>
            <div class="slider-container">
                <span class="slider-label">亮度</span>
                <input type="range" min="0" max="100" value="80" class="slider" id="bathroomBrightness">
            </div>
        </div>
    </div>
</div>

<!-- 空调控制抽屉 -->
<div class="drawer" id="acDrawer">
    <div class="drawer-header">
        <div class="drawer-title">空调控制</div>
        <button class="drawer-close" id="acDrawerClose">×</button>
    </div>
    <div class="drawer-body">
        <div class="temperature-control">
            <button class="temp-btn" id="tempDownDrawer">-</button>
            <div class="current-temp">26°C</div>
            <button class="temp-btn" id="tempUpDrawer">+</button>
        </div>

        <div class="ac-controls">
            <button class="ac-control-btn" id="modeControl" data-target="modeOptions">
                <i class="fas fa-sliders-h"></i>
                <span>模式</span>
                <small id="currentMode">制冷</small>
            </button>
            <button class="ac-control-btn" id="fanSpeedControl" data-target="fanSpeedOptions">
                <i class="fas fa-wind"></i>
                <span>风速</span>
                <small id="currentFanSpeed">二档</small>
            </button>
            <button class="ac-control-btn" id="fanDirControl" data-target="fanDirectionOptions">
                <i class="fas fa-location-arrow"></i>
                <span>风向</span>
                <small id="currentFanDirection">摆风</small>
            </button>
            <button class="ac-control-btn" id="timerControl" data-target="timerOptions">
                <i class="far fa-clock"></i>
                <span>定时</span>
                <small id="currentTimer">关闭</small>
            </button>
        </div>
    </div>
</div>

<!-- 空调模式选项 -->
<div id="modeOptions" class="drawer sub-drawer">
    <div class="drawer-header">
        <div class="drawer-title">选择模式</div>
        <button class="drawer-close">&times;</button>
    </div>
    <div class="drawer-body">
        <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action mode-option" data-mode="cool">
                <div class="d-flex align-items-center">
                    <div class="option-icon cool-icon">
                        <i class="fas fa-snowflake"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">制冷模式</h6>
                        <small class="text-muted">迅速降低室温</small>
                    </div>
                    <i class="fas fa-check ms-auto mode-check" id="coolCheck"></i>
                </div>
            </button>
            <button class="list-group-item list-group-item-action mode-option" data-mode="heat">
                <div class="d-flex align-items-center">
                    <div class="option-icon heat-icon">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">制热模式</h6>
                        <small class="text-muted">提供温暖环境</small>
                    </div>
                    <i class="fas fa-check ms-auto mode-check" id="heatCheck"></i>
                </div>
            </button>
            <button class="list-group-item list-group-item-action mode-option" data-mode="fan">
                <div class="d-flex align-items-center">
                    <div class="option-icon fan-icon">
                        <i class="fas fa-wind"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">通风模式</h6>
                        <small class="text-muted">仅送风不调温</small>
                    </div>
                    <i class="fas fa-check ms-auto mode-check" id="fanCheck"></i>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- 风速选项 -->
<div id="fanSpeedOptions" class="drawer sub-drawer">
    <div class="drawer-header">
        <div class="drawer-title">风速调节</div>
        <button class="drawer-close">&times;</button>
    </div>
    <div class="drawer-body">
        <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action fan-speed-option" data-speed="low">
                <div class="d-flex align-items-center">
                    <div class="option-icon">
                        <i class="fas fa-fan"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">一档</h6>
                        <small class="text-muted">柔和、静音</small>
                    </div>
                    <i class="fas fa-check ms-auto speed-check" id="lowCheck"></i>
                </div>
            </button>
            <button class="list-group-item list-group-item-action fan-speed-option" data-speed="medium">
                <div class="d-flex align-items-center">
                    <div class="option-icon">
                        <i class="fas fa-fan fa-spin-fast"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">二档</h6>
                        <small class="text-muted">适中、舒适</small>
                    </div>
                    <i class="fas fa-check ms-auto speed-check" id="mediumCheck"></i>
                </div>
            </button>
            <button class="list-group-item list-group-item-action fan-speed-option" data-speed="high">
                <div class="d-flex align-items-center">
                    <div class="option-icon">
                        <i class="fas fa-fan fa-spin"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">三档</h6>
                        <small class="text-muted">强劲、迅速</small>
                    </div>
                    <i class="fas fa-check ms-auto speed-check" id="highCheck"></i>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- 风向选项 -->
<div id="fanDirectionOptions" class="drawer sub-drawer">
    <div class="drawer-header">
        <div class="drawer-title">风向设置</div>
        <button class="drawer-close">&times;</button>
    </div>
    <div class="drawer-body">
        <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action direction-option" data-direction="fixed">
                <div class="d-flex align-items-center">
                    <div class="option-icon">
                        <i class="fas fa-arrows-alt-v"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">定向</h6>
                        <small class="text-muted">固定位置送风</small>
                    </div>
                    <i class="fas fa-check ms-auto direction-check" id="fixedCheck"></i>
                </div>
            </button>
            <button class="list-group-item list-group-item-action direction-option" data-direction="swing">
                <div class="d-flex align-items-center">
                    <div class="option-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">摆风</h6>
                        <small class="text-muted">自动上下摆动</small>
                    </div>
                    <i class="fas fa-check ms-auto direction-check" id="swingCheck"></i>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- 定时选项 -->
<div id="timerOptions" class="drawer sub-drawer">
    <div class="drawer-header">
        <div class="drawer-title">定时设置</div>
        <button class="drawer-close">&times;</button>
    </div>
    <div class="drawer-body">
        <div class="p-3">
            <h6 class="mb-3">设置关闭时间（0-5小时）</h6>
            <div class="range-container mb-4">
                <input type="range" class="form-range" min="0" max="5" step="0.5" id="timerHours" value="0">
                <div class="d-flex justify-content-between">
                    <span>0h</span>
                    <span>1h</span>
                    <span>2h</span>
                    <span>3h</span>
                    <span>4h</span>
                    <span>5h</span>
                </div>
            </div>
            <div class="text-center mb-3">
                <h3 id="selectedTime">0小时后关闭</h3>
                <p class="text-muted small">滑动调节定时器时间</p>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-primary" id="confirmTimer">确认定时</button>
                <button class="btn btn-outline-secondary" id="cancelTimer">取消定时</button>
            </div>
        </div>
    </div>
</div>

<!-- 热水器控制抽屉 -->
<div class="drawer" id="waterHeaterDrawer">
    <div class="drawer-header">
        <div class="drawer-title">热水器控制</div>
        <button class="drawer-close" id="waterHeaterDrawerClose">×</button>
    </div>
    <div class="drawer-body">
        <div class="room-control">
            <div class="room-title">
                <i class="fas fa-shower room-icon"></i>
                水温控制
            </div>
            <div class="slider-container">
                <span class="slider-label">水温</span>
                <input type="range" min="0" max="70" value="50" class="slider" id="waterTemperatureControl">
            </div>
            <div class="text-center mt-4">
                <h3 class="current-water-temp"><span id="waterTempValue">50</span>°C</h3>
            </div>
        </div>
    </div>
</div>

<!-- 扫地机器人控制抽屉 -->
<div class="drawer" id="robotDrawer">
    <div class="drawer-header">
        <div class="drawer-title">扫地机器人</div>
        <button class="drawer-close" id="robotDrawerClose">×</button>
    </div>
    <div class="drawer-body">
        <div class="text-center mb-3">
            <button class="btn btn-outline-primary robot-action" data-action="start"><i class="fas fa-play"></i> 启动</button>
            <button class="btn btn-outline-secondary robot-action" data-action="pause"><i class="fas fa-pause"></i> 暂停</button>
            <button class="btn btn-outline-danger robot-action" data-action="stop"><i class="fas fa-stop"></i> 停止</button>
        </div>
        <div class="text-center mt-3" id="robotStatus">状态：待机</div>
    </div>
</div>

<!-- 吸油烟机控制抽屉 -->
<div class="drawer" id="ventilationDrawer">
    <div class="drawer-header">
        <div class="drawer-title">吸油烟机控制</div>
        <button class="drawer-close" id="ventilationDrawerClose">×</button>
    </div>
    <div class="drawer-body">
        <div class="room-control">
            <div class="room-title"><i class="fas fa-wind room-icon"></i> 风速控制</div>
            <div class="slider-container">
                <span class="slider-label">风速</span>
                <input type="range" min="0" max="100" value="80" class="slider" id="ventilationSpeed">
            </div>
            <div class="mt-4 text-center">
                <button class="btn btn-outline-primary btn-lg mx-2" id="ventilationLow">
                    <i class="fas fa-wind"></i> 低风速
                </button>
                <button class="btn btn-outline-primary btn-lg mx-2" id="ventilationMid">
                    <i class="fas fa-wind"></i><i class="fas fa-wind"></i> 中风速
                </button>
                <button class="btn btn-outline-primary btn-lg mx-2" id="ventilationHigh">
                    <i class="fas fa-wind"></i><i class="fas fa-wind"></i><i class="fas fa-wind"></i> 高风速
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 监控视频放大模态框 -->
<div class="modal fade" id="monitoringModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-video text-danger"></i> <span id="monitoringModalTitle">监控视频</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="expanded-monitoring">
                    <img id="expandedMonitorImage" src="" alt="监控视频">
                </div>
                <div class="monitoring-controls-expanded mt-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="screenshotBtn">
                                <i class="fas fa-camera"></i> 截屏
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="intercomBtn">
                                <i class="fas fa-microphone"></i> 对讲
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-success">实时画面</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<input type="hidden" id="elderId" value="{% if elder %}{{ elder.id }}{% endif %}">
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.js"></script>

<!-- WebRTC视频通话对话框 -->
<div class="modal fade" id="videoCallModal" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="callModalTitle">视频通话</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="video-call-container">
                    <!-- 通话状态指示 -->
                    <div class="call-status text-center mb-3">
                        <div id="callStatusText" class="h5">正在连接...</div>
                        <div id="callTimer" class="text-muted">00:00</div>
                    </div>
                    
                    <!-- 视频显示区域 -->
                    <div class="video-streams-container">
                        <!-- 远程视频（大屏幕） -->
                        <div class="remote-video-container">
                            <video id="remoteVideo" autoplay playsinline></video>
                            <div class="remote-user-info">
                                <span id="remoteUserName">对方</span>
                            </div>
                        </div>
                        
                        <!-- 本地视频（小窗口） -->
                        <div class="local-video-container">
                            <video id="localVideo" autoplay playsinline muted></video>
                            <div class="local-user-info">
                                <span>我</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 通话控制按钮 -->
                    <div class="call-controls text-center mt-3">
                        <button id="toggleMicBtn" class="btn btn-outline-dark btn-control">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button id="toggleVideoBtn" class="btn btn-outline-dark btn-control">
                            <i class="fas fa-video"></i>
                        </button>
                        <button id="switchCameraBtn" class="btn btn-outline-dark btn-control">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="endCallBtn" class="btn btn-danger btn-control">
                            <i class="fas fa-phone-slash"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 通话来电显示区域 -->
                <div id="incomingCallContainer" style="display:none">
                    <div class="text-center">
                        <i class="fas fa-phone-volume fa-3x text-primary animated-ring mb-3"></i>
                        <h4 id="incomingCallText">收到视频通话请求</h4>
                        <p id="callerName" class="text-muted">来自: 未知</p>
                        <div class="mt-4">
                            <button id="acceptCallBtn" class="btn btn-success me-2">
                                <i class="fas fa-phone"></i> 接听
                            </button>
                            <button id="rejectCallBtn" class="btn btn-danger">
                                <i class="fas fa-phone-slash"></i> 拒绝
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加视频通话相关样式 -->
<style>
    .video-call-container {
        width: 100%;
    }
    
    .video-streams-container {
        display: flex;
        flex-direction: column;
        position: relative;
        height: 60vh;
        max-height: 500px;
    }
    
    .remote-video-container {
        width: 100%;
        height: 100%;
        position: relative;
        background: #202124;
        border-radius: 8px;
        overflow: hidden;
    }
    
    #remoteVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .local-video-container {
        position: absolute;
        width: 30%;
        max-width: 200px;
        height: auto;
        bottom: 10px;
        right: 10px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    #localVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #444;
    }
    
    .call-controls {
        margin-top: 15px;
    }
    
    .btn-control {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin: 0 5px;
        font-size: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .remote-user-info, .local-user-info {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 5px 10px;
        background: rgba(0,0,0,0.5);
        color: white;
    }
    
    .local-user-info {
        font-size: 12px;
    }
    
    .animated-ring {
        animation: ring 2s infinite;
    }
    
    @keyframes ring {
        0% { transform: rotate(0); }
        5% { transform: rotate(15deg); }
        10% { transform: rotate(-15deg); }
        15% { transform: rotate(15deg); }
        20% { transform: rotate(-15deg); }
        25% { transform: rotate(0); }
        100% { transform: rotate(0); }
    }
</style>

<script src="{% static 'js/webrtc.js' %}"></script>
<script>
// 使用DOMContentLoaded事件确保DOM元素已加载
document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成，开始初始化功能...");
    
    // 如果有老人ID才初始化视频通话功能
    if(document.getElementById('elderId')?.value) {
        console.log("初始化视频通话功能...");
        initVideoCall(); // 初始化视频通话功能
    }
    
    // 初始化健康数据图表
    var healthChart;
    initHealthChart();
    
    // 获取健康数据
    fetchHealthData();
    
    // 页面交互初始化
    initInteractions();
    
    // 初始化温度控制
    initTemperatureControl();
    
    // 初始化视频监控
    initVideoMonitoring();
    
    // 设备控制事件绑定
    initDeviceControls();
    
    // 刷新按钮点击事件
    document.getElementById('refreshHealthData')?.addEventListener('click', fetchHealthData);
    
    // 图表类型和周期变化事件
    document.getElementById('chartType')?.addEventListener('change', updateChart);
    document.getElementById('chartPeriod')?.addEventListener('change', fetchHealthData);
});

// 初始化视频通话功能
function initVideoCall() {
    console.log("初始化视频通话功能...");
    
    // DOM元素
    const videoCallModal = document.getElementById('videoCallModal');
    const callStatusText = document.getElementById('callStatusText');
    const remoteUserName = document.getElementById('remoteUserName');
    const toggleMicBtn = document.getElementById('toggleMicBtn');
    const toggleVideoBtn = document.getElementById('toggleVideoBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const acceptCallBtn = document.getElementById('acceptCallBtn');
    const rejectCallBtn = document.getElementById('rejectCallBtn');
    const videoCallContainer = document.querySelector('.video-call-container');
    const incomingCallContainer = document.getElementById('incomingCallContainer');
    const callerName = document.getElementById('callerName');
    
    // 获取当前用户信息
    const currentUserId = document.querySelector('meta[name="user-id"]')?.content || "0";
    const currentUserName = document.querySelector('meta[name="user-name"]')?.content || "用户";
    const elderId = document.getElementById('elderId')?.value || "";
    const familyId = document.querySelector('meta[name="family-id"]')?.content || "";
    
    // 创建视频通话管理器
    const rtcClient = new WebRTCClient(currentUserId, currentUserName);
    
    // 初始化WebRTC - 只在需要时连接
    const roomName = `video_call_${elderId || familyId}`;
    
    // 仅当点击视频通话按钮时才连接WebSocket，而不是页面加载时就连接
    // rtcClient.connect(roomName); - 移除这一行，改为在需要时连接
    
    // Bootstrap模态框实例
    const videoCallModalInstance = new bootstrap.Modal(videoCallModal);
    
    // 处理视频通话按钮点击事件
    const videoCallBtn = document.getElementById('videoCallBtn');
    if (videoCallBtn) {
        videoCallBtn.addEventListener('click', function() {
            // 对方ID取决于当前用户角色
            const targetUserId = elderId ? elderId : familyId;
            if (!targetUserId) {
                showToast('找不到通话对象', 'error');
                return;
            }
            
            // 连接WebSocket
            rtcClient.connect(roomName);
            
            // 显示通话界面
            videoCallModalInstance.show();
            callStatusText.textContent = '正在呼叫...';
            
            // 显示通话界面
            videoCallContainer.style.display = 'block';
            incomingCallContainer.style.display = 'none';
            
            // 发起通话
            rtcClient.startCall(targetUserId, 'video');
        });
    }
    
    // 处理通话控制按钮
    if (toggleMicBtn) {
        toggleMicBtn.addEventListener('click', function() {
            const enabled = rtcClient.toggleAudio();
            this.classList.toggle('btn-danger', !enabled);
            this.innerHTML = enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        });
    }
    
    if (toggleVideoBtn) {
        toggleVideoBtn.addEventListener('click', function() {
            const enabled = rtcClient.toggleVideo();
            this.classList.toggle('btn-danger', !enabled);
            this.innerHTML = enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
        });
    }
    
    if (endCallBtn) {
        endCallBtn.addEventListener('click', function() {
            rtcClient.endCall();
            videoCallModalInstance.hide();
        });
    }
    
    // 模态框关闭时结束通话
    videoCallModal.addEventListener('hidden.bs.modal', function() {
        rtcClient.endCall();
    });
    
    // 接听/拒绝通话
    if (acceptCallBtn) {
        acceptCallBtn.addEventListener('click', function() {
            // 显示通话界面
            videoCallContainer.style.display = 'block';
            incomingCallContainer.style.display = 'none';
            
            // 接受通话
            rtcClient.acceptCall();
        });
    }
    
    if (rejectCallBtn) {
        rejectCallBtn.addEventListener('click', function() {
            // 拒绝通话
            rtcClient.rejectCall();
            
            // 隐藏模态框
            videoCallModalInstance.hide();
        });
    }
    
    // 事件监听回调
    rtcClient.onCallRequest = function(senderId, senderName, callType) {
        // 显示来电界面
        videoCallContainer.style.display = 'none';
        incomingCallContainer.style.display = 'block';
        
        // 设置来电信息
        callerName.textContent = `来自: ${senderName}`;
        
        // 显示模态框
        videoCallModalInstance.show();
    };
    
    rtcClient.onCallEnded = function() {
        // 隐藏模态框
        videoCallModalInstance.hide();
    };
    
    rtcClient.onError = function(message) {
        // 显示错误信息
        showToast(message, 'error');
    };
}

// 显示提示消息
function showToast(message, type) {
    // 创建提示元素
    var toast = document.createElement('div');
    toast.className = 'toast-notification toast-' + (type || 'info');
    
    // 设置图标
    var icon = 'info-circle';
    if (type === 'success') icon = 'check-circle';
    if (type === 'danger' || type === 'error') icon = 'times-circle';
    if (type === 'warning') icon = 'exclamation-triangle';
    
    toast.innerHTML = `
        <div class="toast-icon"><i class="fas fa-${icon}"></i></div>
        <div class="toast-content">${message}</div>
        <button class="toast-close">&times;</button>
    `;
    
    // 添加到页面
    document.body.appendChild(toast);
    
    // 关闭按钮事件
    var closeBtn = toast.querySelector('.toast-close');
    if(closeBtn) {
        closeBtn.onclick = function() {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        };
    }
    
    // 自动关闭
    setTimeout(function() {
        if (document.body.contains(toast)) {
            document.body.removeChild(toast);
        }
    }, 3000);
}

// 添加设备控制和其他交互功能
document.addEventListener('DOMContentLoaded', function() {
    // 初始化健康数据图表
    var healthChart;
    initHealthChart();
    
    // 获取健康数据
    fetchHealthData();
    
    // 页面交互初始化
    initInteractions();
    
    // 设备控制事件绑定
    initDeviceControls();
    
    // 刷新按钮点击事件
    document.getElementById('refreshHealthData')?.addEventListener('click', fetchHealthData);
    
    // 图表类型和周期变化事件
    document.getElementById('chartType')?.addEventListener('change', updateChart);
    document.getElementById('chartPeriod')?.addEventListener('change', fetchHealthData);

    // 控制台输出初始化完成信息
    console.log("页面初始化完成");
});

// 打开抽屉
function openDrawer(drawer) {
    if (!drawer) return;
    const overlay = document.getElementById('overlay');
    drawer.classList.add('open');
    if (overlay) overlay.classList.add('open');
    console.log("抽屉已打开:", drawer.id);
}

// 关闭抽屉
function closeDrawer(drawer) {
    if (!drawer) return;
    drawer.classList.remove('open');
    console.log("抽屉已关闭:", drawer.id);
}

// 关闭所有抽屉
function closeAllDrawers() {
    const overlay = document.getElementById('overlay');
    document.querySelectorAll('.drawer').forEach(function(drawer) {
        // 只关闭主抽屉，不关闭子抽屉
        if (!drawer.classList.contains('sub-drawer')) {
            drawer.classList.remove('open');
        }
    });
    
    // 也关闭子抽屉
    document.querySelectorAll('.sub-drawer').forEach(function(drawer) {
        drawer.classList.remove('open');
    });
    
    if (overlay) overlay.classList.remove('open');
    console.log("所有抽屉已关闭");
}

// 初始化页面交互功能
function initInteractions() {
    console.log('初始化页面交互...');
    
    // 抽屉菜单
    const lightCard = document.getElementById('lightCard');
    const acCard = document.getElementById('acCard');
    const waterHeaterCard = document.getElementById('waterHeaterCard');
    const ventilationCard = document.getElementById('ventilationCard');
    
    const lightDrawer = document.getElementById('lightDrawer');
    const acDrawer = document.getElementById('acDrawer');
    const waterHeaterDrawer = document.getElementById('waterHeaterDrawer');
    const ventilationDrawer = document.getElementById('ventilationDrawer');
    
    const overlay = document.getElementById('overlay');
    
    // 设备卡片与抽屉菜单的映射关系
    const deviceDrawerMap = {
        'light': 'lightDrawer',
        'ac': 'acDrawer',
        'water_heater': 'waterHeaterDrawer',
        'ventilation': 'ventilationDrawer'
    };
    
    // 绑定设备开关事件
    document.querySelectorAll('.device-control').forEach(function(control) {
        control.addEventListener('change', function() {
            const deviceType = this.dataset.type;
            const location = this.dataset.location;
            const isOn = this.checked;
            
            console.log(`设备状态变更: ${deviceType} @ ${location}, 状态: ${isOn ? '开启' : '关闭'}`);
            
            // 关闭所有抽屉
            closeAllDrawers();
            
            // 如果设备开启，显示对应抽屉
            if (isOn && deviceDrawerMap[deviceType]) {
                const drawer = document.getElementById(deviceDrawerMap[deviceType]);
                if (drawer) {
                    openDrawer(drawer);
                }
            }
            
            // 显示提示消息
            const deviceName = getDeviceName(deviceType);
            showToast(`${deviceName}已${isOn ? '开启' : '关闭'}`, isOn ? 'success' : 'info');
            
            // 更新设备卡片状态
            updateDeviceCardState(deviceType, location, isOn);
        });
    });
    
    // 空调控制抽屉功能
    initACControls();
    
    // 灯光控制
    if (lightCard && lightDrawer) {
        lightCard.addEventListener('click', function(e) {
            // 不要处理开关控件的点击
            if (e.target.tagName === 'INPUT' || e.target.classList.contains('device-slider')) return;
            
            const switchInput = this.querySelector('input[type="checkbox"]');
            if (switchInput) {
                switchInput.checked = !switchInput.checked;
                
                // 手动触发change事件
                const event = new Event('change');
                switchInput.dispatchEvent(event);
            }
        });
    }
    
    // 空调控制
    if (acCard && acDrawer) {
        acCard.addEventListener('click', function(e) {
            // 不要处理开关控件和温度控制按钮的点击
            if (e.target.tagName === 'INPUT' || e.target.classList.contains('device-slider') || 
                e.target.classList.contains('btn-temperature-control') || 
                e.target.closest('.btn-temperature-control')) return;
            
            const switchInput = this.querySelector('input[type="checkbox"]');
            if (switchInput) {
                switchInput.checked = !switchInput.checked;
                
                // 手动触发change事件
                const event = new Event('change');
                switchInput.dispatchEvent(event);
            }
        });
    }
    
    // 热水器控制
    if (waterHeaterCard && waterHeaterDrawer) {
        waterHeaterCard.addEventListener('click', function(e) {
            // 不要处理开关控件和下拉选择器的点击
            if (e.target.tagName === 'INPUT' || e.target.classList.contains('device-slider') || 
                e.target.tagName === 'SELECT' || e.target.tagName === 'OPTION') return;
            
            const switchInput = this.querySelector('input[type="checkbox"]');
            if (switchInput) {
                switchInput.checked = !switchInput.checked;
                
                // 手动触发change事件
                const event = new Event('change');
                switchInput.dispatchEvent(event);
            }
        });
    }
    
    // 吸油烟机控制
    if (ventilationCard && ventilationDrawer) {
        ventilationCard.addEventListener('click', function(e) {
            // 不要处理开关控件的点击
            if (e.target.tagName === 'INPUT' || e.target.classList.contains('device-slider')) return;
            
            const switchInput = this.querySelector('input[type="checkbox"]');
            if (switchInput) {
                switchInput.checked = !switchInput.checked;
                
                // 手动触发change事件
                const event = new Event('change');
                switchInput.dispatchEvent(event);
            }
        });
    }
    
    // 所有抽屉关闭按钮
    document.querySelectorAll('.drawer-close').forEach(function(closeBtn) {
        closeBtn.addEventListener('click', function() {
            // 找到所属的抽屉
            const drawer = this.closest('.drawer');
            if (drawer) {
                // 检查是否是子抽屉
                if (drawer.classList.contains('sub-drawer')) {
                    // 只关闭子抽屉，不关闭主抽屉
                    drawer.classList.remove('open');
                } else {
                    // 找到对应的设备类型
                    const deviceType = getDeviceTypeFromDrawerId(drawer.id);
                    
                    // 关闭该设备类型的开关
                    if (deviceType) {
                        const deviceSwitch = document.querySelector(`.device-control[data-type="${deviceType}"]`);
                        if (deviceSwitch) {
                            deviceSwitch.checked = false;
                            
                            // 手动触发change事件
                            const event = new Event('change');
                            deviceSwitch.dispatchEvent(event);
                        }
                    }
                    
                    // 关闭抽屉
                    closeDrawer(drawer);
                }
            }
        });
    });
    
    // 点击遮罩层关闭所有抽屉和设备开关
    if (overlay) {
        overlay.addEventListener('click', function() {
            // 查找当前打开的抽屉
            const openDrawer = document.querySelector('.drawer.open:not(.sub-drawer)');
            if (openDrawer) {
                // 找到对应的设备类型
                const deviceType = getDeviceTypeFromDrawerId(openDrawer.id);
                
                // 关闭该设备类型的开关
                if (deviceType) {
                    const deviceSwitch = document.querySelector(`.device-control[data-type="${deviceType}"]`);
                    if (deviceSwitch) {
                        deviceSwitch.checked = false;
                        
                        // 手动触发change事件
                        const event = new Event('change');
                        deviceSwitch.dispatchEvent(event);
                    }
                }
            }
            
            // 关闭所有抽屉
            closeAllDrawers();
        });
    }
    
    // 从抽屉ID获取设备类型
    function getDeviceTypeFromDrawerId(drawerId) {
        for (const [deviceType, drawerName] of Object.entries(deviceDrawerMap)) {
            if (drawerName === drawerId) {
                return deviceType;
            }
        }
        return null;
    }
}

// 初始化设备控制
function initDeviceControls() {
    // 这部分功能已移到initInteractions中处理
    console.log('设备控制初始化完成');
    
    // 门锁临时解锁
    const temporaryUnlock = document.getElementById('temporaryUnlock');
    if (temporaryUnlock) {
        temporaryUnlock.addEventListener('click', function() {
            showToast('门锁已临时解锁，5秒后自动锁定', 'warning');
            
            // 模拟5秒后自动锁定
            setTimeout(function() {
                showToast('门锁已自动锁定', 'success');
            }, 5000);
        });
    }
}

// 获取设备名称
function getDeviceName(deviceType) {
    const deviceNames = {
        'light': '灯光',
        'ac': '空调',
        'water_heater': '热水器',
        'ventilation': '吸油烟机',
        'lock': '门锁'
    };
    return deviceNames[deviceType] || '设备';
}

// 更新设备卡片状态
function updateDeviceCardState(deviceType, location, isOn) {
    const selector = `[data-device="${deviceType}"][data-location="${location}"]`;
    const deviceCard = document.querySelector(selector);
    if (deviceCard) {
        if (isOn) {
            deviceCard.classList.add('active');
        } else {
            deviceCard.classList.remove('active');
        }
    }
}

// 初始化健康数据图表
function initHealthChart() {
    var options = {
        series: [{
            name: '心率',
            data: []
        }],
        chart: {
            height: 250,
            type: 'line',
            toolbar: {
                show: false
            },
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
        },
        stroke: {
            width: 2,
            curve: 'smooth'
        },
        colors: ['#dc3545'],
        grid: {
            borderColor: '#e9e9e9',
            padding: {
                left: 10,
                right: 10
            }
        },
        markers: {
            size: 4,
            colors: ["#FFA41B"],
            strokeColors: "#fff",
            strokeWidth: 2,
            hover: {
                size: 6,
            }
        },
        xaxis: {
            categories: [],
            labels: {
                style: {
                    colors: '#6c757d',
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: '#6c757d',
                }
            }
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function(val) {
                    return val + " 次/分";
                }
            }
        },
        responsive: [{
            breakpoint: 768,
            options: {
                chart: {
                    height: 200
                }
            }
        }]
    };

    var chartElem = document.getElementById('healthChart');
    if (chartElem) {
        healthChart = new ApexCharts(chartElem, options);
        healthChart.render();
    } else {
        console.error('找不到图表容器元素');
    }
}

// 获取健康数据
function fetchHealthData() {
    const elderId = document.getElementById('elderId')?.value;
    if (!elderId) {
        console.error('找不到老人ID');
        return;
    }
    
    const chartPeriod = document.getElementById('chartPeriod')?.value || 'week';
    
    // 在真实场景中应从API获取数据
    // 这里模拟API响应
    simulateHealthDataResponse(elderId, chartPeriod);
}

// 模拟健康数据响应
function simulateHealthDataResponse(elderId, period) {
    // 生成模拟数据
    let data;
    if (period === 'week') {
        data = {
            dates: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
            heartRate: [72, 75, 76, 74, 73, 70, 75],
            bloodOxygen: [98, 97, 98, 99, 98, 97, 98],
            temperature: [36.5, 36.7, 36.4, 36.6, 36.8, 36.5, 36.6],
            bloodPressure: [
                {systolic: 118, diastolic: 78},
                {systolic: 122, diastolic: 80},
                {systolic: 120, diastolic: 79},
                {systolic: 119, diastolic: 77},
                {systolic: 121, diastolic: 81},
                {systolic: 118, diastolic: 78},
                {systolic: 120, diastolic: 80}
            ],
            steps: [5200, 6500, 4800, 7200, 5500, 8000, 5632],
            sleepQuality: [7.5, 6.8, 7.2, 8.0, 7.0, 8.5, 7.2]
        };
    } else {
        // 月度数据
        data = {
            dates: Array.from({length: 30}, (_, i) => (i + 1) + '日'),
            heartRate: Array.from({length: 30}, () => Math.floor(Math.random() * 10) + 70),
            bloodOxygen: Array.from({length: 30}, () => Math.floor(Math.random() * 3) + 97),
            temperature: Array.from({length: 30}, () => (Math.random() * 0.8 + 36.2).toFixed(1)),
            bloodPressure: Array.from({length: 30}, () => ({
                systolic: Math.floor(Math.random() * 10) + 115,
                diastolic: Math.floor(Math.random() * 10) + 75
            })),
            steps: Array.from({length: 30}, () => Math.floor(Math.random() * 5000) + 3000),
            sleepQuality: Array.from({length: 30}, () => (Math.random() * 3 + 6).toFixed(1))
        };
    }
    
    // 使用最新数据更新显示
    updateHealthStats(data);
    
    // 更新图表
    updateHealthChart(data);
}

// 更新健康统计数据
function updateHealthStats(data) {
    // 获取最新的数据（数组的最后一项）
    const latest = {
        heartRate: data.heartRate[data.heartRate.length - 1],
        bloodOxygen: data.bloodOxygen[data.bloodOxygen.length - 1],
        temperature: data.temperature[data.temperature.length - 1],
        bloodPressure: data.bloodPressure[data.bloodPressure.length - 1],
        steps: data.steps[data.steps.length - 1],
        sleepQuality: data.sleepQuality[data.sleepQuality.length - 1]
    };
    
    // 更新显示
    document.getElementById('heartRate').textContent = latest.heartRate;
    document.getElementById('bloodOxygen').textContent = latest.bloodOxygen + '%';
    document.getElementById('temperature').textContent = latest.temperature + '°C';
    document.getElementById('bloodPressure').textContent = latest.bloodPressure.systolic + '/' + latest.bloodPressure.diastolic;
    document.getElementById('steps').textContent = latest.steps;
    document.getElementById('sleepQuality').textContent = latest.sleepQuality + '小时';
}

// 更新健康图表
function updateHealthChart(data) {
    if (!healthChart) {
        console.error('图表未初始化');
        return;
    }
    
    const chartType = document.getElementById('chartType')?.value || 'line';
    
    healthChart.updateOptions({
        chart: {
            type: chartType
        },
        series: [{
            name: '心率',
            data: data.heartRate
        }],
        xaxis: {
            categories: data.dates
        }
    });
}

// 更新图表类型
function updateChart() {
    const chartType = document.getElementById('chartType')?.value || 'line';
    
    if (healthChart) {
        healthChart.updateOptions({
            chart: {
                type: chartType
            }
        });
    }
}



// 从抽屉ID获取设备类型
function getDeviceTypeFromDrawerId(drawerId) {
    for (const [deviceType, drawerName] of Object.entries(deviceDrawerMap)) {
        if (drawerName === drawerId) {
            return deviceType;
        }
    }
    return null;
}

// 初始化空调高级控制功能
function initACControls() {
    console.log("初始化空调高级控制...");
    
    // 空调状态
    let acState = {
        mode: "cool",  // cool, heat, fan
        fanSpeed: "medium", // low, medium, high
        fanDirection: "swing", // fixed, swing
        timer: 0 // 小时
    };
    
    // 显示选中状态
    updateACSelections();
    
    // 绑定选项卡片点击事件
    document.querySelectorAll('[data-target]').forEach(card => {
        card.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止事件冒泡
            const targetId = this.getAttribute('data-target');
            const targetDrawer = document.getElementById(targetId);
            if (targetDrawer) {
                console.log(`打开子抽屉: ${targetId}`);
                targetDrawer.classList.add('open');
            } else {
                console.log(`找不到子抽屉 ${targetId}`);
            }
        });
    });
    
    // 子抽屉关闭按钮
    document.querySelectorAll('.sub-drawer .drawer-close').forEach(function(closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止事件冒泡
            const drawer = this.closest('.drawer');
            if (drawer) {
                console.log(`关闭子抽屉: ${drawer.id}`);
                drawer.classList.remove('open');
            }
        });
    });
    
    // 绑定模式选择
    document.querySelectorAll('.mode-option').forEach(option => {
        option.addEventListener('click', function() {
            const mode = this.getAttribute('data-mode');
            acState.mode = mode;
            updateACSelections();
            
            // 关闭子抽屉
            this.closest('.sub-drawer').classList.remove('open');
            
            // 显示提示
            let message = '';
            if (mode === 'cool') message = '已开始制冷';
            if (mode === 'heat') message = '已开始制热';
            if (mode === 'fan') message = '已切换到通风模式';
            showToast(message, 'success');
        });
    });
    
    // 绑定风速选择
    document.querySelectorAll('.fan-speed-option').forEach(option => {
        option.addEventListener('click', function() {
            const speed = this.getAttribute('data-speed');
            acState.fanSpeed = speed;
            updateACSelections();
            
            // 关闭子抽屉
            this.closest('.sub-drawer').classList.remove('open');
            
            // 显示提示
            let message = '';
            if (speed === 'low') message = '风速已设为一档';
            if (speed === 'medium') message = '风速已设为二档';
            if (speed === 'high') message = '风速已设为三档';
            showToast(message, 'info');
        });
    });
    
    // 绑定风向选择
    document.querySelectorAll('.direction-option').forEach(option => {
        option.addEventListener('click', function() {
            const direction = this.getAttribute('data-direction');
            acState.fanDirection = direction;
            updateACSelections();
            
            // 关闭子抽屉
            this.closest('.sub-drawer').classList.remove('open');
            
            // 显示提示
            let message = direction === 'fixed' ? '已设置为定向送风' : '已设置为摆风模式';
            showToast(message, 'info');
        });
    });
    
    // 绑定定时器滑动条
    const timerSlider = document.getElementById('timerHours');
    const selectedTime = document.getElementById('selectedTime');
    
    if (timerSlider && selectedTime) {
        timerSlider.addEventListener('input', function() {
            const hours = parseFloat(this.value);
            selectedTime.textContent = hours > 0 ? 
                `${hours}小时后关闭` : 
                '0小时后关闭';
        });
    }
    
    // 确认定时按钮
    document.getElementById('confirmTimer')?.addEventListener('click', function() {
        const hours = parseFloat(timerSlider.value);
        acState.timer = hours;
        
        // 更新显示
        document.getElementById('currentTimer').textContent = 
            hours > 0 ? `${hours}小时` : '关闭';
        
        // 关闭子抽屉
        document.getElementById('timerOptions').classList.remove('open');
        
        // 显示提示
        if (hours > 0) {
            showToast(`已设置${hours}小时后关闭`, 'info');
        } else {
            showToast('已取消定时', 'info');
        }
    });
    
    // 取消定时按钮
    document.getElementById('cancelTimer')?.addEventListener('click', function() {
        timerSlider.value = 0;
        selectedTime.textContent = '0小时后关闭';
        acState.timer = 0;
        document.getElementById('currentTimer').textContent = '关闭';
        
        // 关闭子抽屉
        document.getElementById('timerOptions').classList.remove('open');
        
        // 显示提示
        showToast('已取消定时', 'info');
    });
    
    // 更新选择状态的函数
    function updateACSelections() {
        // 更新模式显示
        document.getElementById('currentMode').textContent = 
            acState.mode === 'cool' ? '制冷' : 
            acState.mode === 'heat' ? '制热' : '通风';
        
        // 更新风速显示
        document.getElementById('currentFanSpeed').textContent = 
            acState.fanSpeed === 'low' ? '一档' : 
            acState.fanSpeed === 'medium' ? '二档' : '三档';
        
        // 更新风向显示
        document.getElementById('currentFanDirection').textContent = 
            acState.fanDirection === 'fixed' ? '定向' : '摆风';
        
        // 更新定时显示
        document.getElementById('currentTimer').textContent = 
            acState.timer > 0 ? `${acState.timer}小时` : '关闭';
        
        // 更新选择标记
        document.querySelectorAll('.mode-check').forEach(check => {
            check.style.visibility = 'hidden';
        });
        const modeCheckElement = document.getElementById(`${acState.mode}Check`);
        if (modeCheckElement) {
            modeCheckElement.style.visibility = 'visible';
        }
        
        document.querySelectorAll('.speed-check').forEach(check => {
            check.style.visibility = 'hidden';
        });
        const speedCheckElement = document.getElementById(`${acState.fanSpeed}Check`);
        if (speedCheckElement) {
            speedCheckElement.style.visibility = 'visible';
        }
        
        document.querySelectorAll('.direction-check').forEach(check => {
            check.style.visibility = 'hidden';
        });
        const directionCheckElement = document.getElementById(`${acState.fanDirection}Check`);
        if (directionCheckElement) {
            directionCheckElement.style.visibility = 'visible';
        }
    }
}

// 监控视频
function initVideoMonitoring() {
    console.log('初始化监控视频功能...');
    
    const expandBtn = document.getElementById('expandBtn');
    const expandedMonitoring = document.getElementById('expandedMonitoring');
    const closeExpandedBtn = document.getElementById('closeExpandedBtn');
    const monitoringImage = document.getElementById('monitoringImage');
    const expandedVideo = document.getElementById('expandedVideo');
    const overlay = document.getElementById('overlay');
    
    // 监控视频切换功能
    const prevCamera = document.getElementById('prevCamera');
    const nextCamera = document.getElementById('nextCamera');
    const cameraCounter = document.getElementById('cameraCounter');
    const monitoringLocation = document.getElementById('monitoringLocation');
    
    // 定义监控摄像头列表
    const cameras = [
        { location: '客厅', image: '{% static "img/demo/living_room.jpg" %}' },
        { location: '卧室', image: '{% static "img/demo/bedroom.jpg" %}' },
        { location: '厨房', image: '{% static "img/demo/kitchen.jpg" %}' }
    ];
    
    let currentCameraIndex = 0;
    
    // 更新监控画面
    function updateCamera() {
        if (monitoringImage && monitoringLocation) {
            monitoringImage.src = cameras[currentCameraIndex].image;
            monitoringLocation.textContent = cameras[currentCameraIndex].location;
            cameraCounter.textContent = `${currentCameraIndex + 1} / ${cameras.length}`;
        }
    }
    
    // 绑定上一个摄像头按钮
    if (prevCamera) {
        prevCamera.addEventListener('click', function() {
            currentCameraIndex = (currentCameraIndex - 1 + cameras.length) % cameras.length;
            updateCamera();
            showToast(`已切换到${cameras[currentCameraIndex].location}摄像头`, 'info');
        });
    }
    
    // 绑定下一个摄像头按钮
    if (nextCamera) {
        nextCamera.addEventListener('click', function() {
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
            updateCamera();
            showToast(`已切换到${cameras[currentCameraIndex].location}摄像头`, 'info');
        });
    }
    
    if (expandBtn && expandedMonitoring) {
        expandBtn.addEventListener('click', function() {
            if (monitoringImage && expandedVideo) {
                expandedVideo.src = monitoringImage.src;
            }
            expandedMonitoring.style.display = 'block';
            overlay.classList.add('open');
        });
    }
    
    if (closeExpandedBtn) {
        closeExpandedBtn.addEventListener('click', function() {
            expandedMonitoring.style.display = 'none';
            overlay.classList.remove('open');
        });
    }
    
    // 全屏查看按钮
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function() {
            const monitoringImage = document.getElementById('monitoringImage');
            if (monitoringImage) {
                // 创建一个临时容器来全屏显示图像
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                container.style.zIndex = '9999';
                container.style.display = 'flex';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                
                // 克隆图像元素
                const fullImage = document.createElement('img');
                fullImage.src = monitoringImage.src;
                fullImage.style.maxWidth = '95%';
                fullImage.style.maxHeight = '95%';
                fullImage.style.objectFit = 'contain';
                
                // 添加关闭按钮
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '20px';
                closeBtn.style.right = '20px';
                closeBtn.style.fontSize = '30px';
                closeBtn.style.backgroundColor = 'transparent';
                closeBtn.style.border = 'none';
                closeBtn.style.color = 'white';
                closeBtn.style.cursor = 'pointer';
                closeBtn.onclick = function() {
                    document.body.removeChild(container);
                };
                
                // 添加控制按钮（截屏和对讲）
                const controlsDiv = document.createElement('div');
                controlsDiv.style.position = 'absolute';
                controlsDiv.style.bottom = '20px';
                controlsDiv.style.left = '50%';
                controlsDiv.style.transform = 'translateX(-50%)';
                
                // 截屏按钮
                const screenshotBtn = document.createElement('button');
                screenshotBtn.innerHTML = '<i class="fas fa-camera"></i> 截屏';
                screenshotBtn.className = 'btn btn-sm btn-outline-secondary me-2';
                screenshotBtn.onclick = function() {
                    showToast('截屏已保存', 'success');
                };
                
                // 对讲按钮
                const intercomBtn = document.createElement('button');
                intercomBtn.innerHTML = '<i class="fas fa-microphone"></i> 对讲';
                intercomBtn.className = 'btn btn-sm btn-outline-primary';
                intercomBtn.onclick = function() {
                    showToast('对讲已开启', 'info');
                };
                
                // 将按钮添加到控制栏
                controlsDiv.appendChild(screenshotBtn);
                controlsDiv.appendChild(intercomBtn);
                
                // 将元素添加到容器
                container.appendChild(fullImage);
                container.appendChild(closeBtn);
                container.appendChild(controlsDiv);
                
                // 将容器添加到文档
                document.body.appendChild(container);
                
                // ESC键退出全屏
                const escHandler = function(e) {
                    if (e.key === 'Escape' && document.body.contains(container)) {
                        document.body.removeChild(container);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }
        });
    }
}

// 温度控制
function initTemperatureControl() {
    console.log('初始化温度控制...');
    
    const tempUp = document.getElementById('tempUp');
    const tempDown = document.getElementById('tempDown');
    const tempUpDrawer = document.getElementById('tempUpDrawer');
    const tempDownDrawer = document.getElementById('tempDownDrawer');
    const currentTemp = document.querySelector('.current-temp');
    
    function updateTemp(direction) {
        if (currentTemp) {
            let temp = parseInt(currentTemp.textContent);
            if (isNaN(temp)) temp = 26;
            if (direction === 'up' && temp < 30) temp += 1;
            if (direction === 'down' && temp > 16) temp -= 1;
            currentTemp.textContent = temp + '°C';
            showToast(`温度已调整为 ${temp}°C`, 'info');
        }
    }
    
    if (tempUp) tempUp.addEventListener('click', function() { updateTemp('up'); });
    if (tempDown) tempDown.addEventListener('click', function() { updateTemp('down'); });
    if (tempUpDrawer) tempUpDrawer.addEventListener('click', function() { updateTemp('up'); });
    if (tempDownDrawer) tempDownDrawer.addEventListener('click', function() { updateTemp('down'); });
}
</script>


{% endblock extra_js %}